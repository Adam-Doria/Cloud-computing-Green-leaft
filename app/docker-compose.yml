version: '3.8'

services:
  caddy:
    image: caddy:2.7-alpine
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - medusa-backend
      - medusa-storefront

  medusa-backend:
    build: ./backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # Base de données (injecté par le .env généré par Terraform)
      - DATABASE_URL=${DATABASE_URL}
      # Redis (injecté par le .env généré par Terraform)
      - REDIS_URL=${REDIS_URL}
      # S3 / Cloudflare R2
      - S3_URL=${S3_URL}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      # Secrets Medusa
      - JWT_SECRET=${JWT_SECRET:-supersecret}
      - COOKIE_SECRET=${COOKIE_SECRET:-supersecret}
      # CORS (Important pour que le front parle au back)
      - STORE_CORS=http://localhost,http://caddy,http://medusa-storefront:8000,http://${LB_DNS_NAME:-localhost}
      - ADMIN_CORS=http://localhost,http://caddy,http://medusa-storefront:8000
      - AUTH_CORS=http://localhost,http://caddy,http://medusa-storefront:8000

  medusa-storefront:
    build: ./storefront
    restart: unless-stopped
    environment:
      # URL publique pour le navigateur (via le Load Balancer ou Caddy)
      - NEXT_PUBLIC_MEDUSA_BACKEND_URL=http://localhost:8000
      # URL interne pour le SSR (Server Side Rendering)
      - MEDUSA_BACKEND_URL=http://medusa-backend:9000
      - NEXT_PUBLIC_BASE_URL=http://localhost

volumes:
  caddy_data:
  caddy_config: